<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <link rel="icon" type="image/png" href="img/favicon.png">
  <script type="text/javascript" src="https://unpkg.com/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script>
  <link href="https://unpkg.com/vis-timeline/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
  <style type="text/css">
    #visualization {
      width: 100%;
      height: 400px;
      border: 1px solid lightgray;
    }
  </style>
  </head>
  <body>

  <div style="margin-bottom: 10px;">
      <button id="add-event-btn" style="padding: 5px 10px; cursor: pointer;">Add Event</button> 
      <a href="https://visjs.github.io/vis-timeline/examples/timeline/">docs</a>
  </div>
  <div id="visualization"></div>

  <script type="text/javascript">
    const container = document.getElementById('visualization');
    const addEventBtn = document.getElementById('add-event-btn');
    let timeline;
    let items;

    function saveEvents() {
        const data = items.get();
        fetch('/api/events', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => response.text())
        .then(data => {
            console.log('Success:', data);
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }

    addEventBtn.addEventListener('click', () => {
        const content = prompt('Enter text content for new item:');
        if (content != null) {
            const newItem = {
                id: Date.now(),
                content: content,
                start: new Date().toISOString().slice(0, 10), // YYYY-MM-DD
                image: 'img/flag.png'
            };
            items.add(newItem);
            saveEvents();
            timeline.setWindow(newItem.start, new Date(new Date(newItem.start).getTime() + 1000 * 60 * 60 * 24 * 2)); // Focus on new item
        }
    });

    fetch('/events.json')
        .then(response => response.json())
        .then(data => {
            items = new vis.DataSet(data);

            const options = {
                editable: true,
                template: function (item, element, data) {
                    const container = document.createElement('span');
                    if (item.image) {
                        const img = document.createElement('img');
                        img.src = item.image;
                        img.style.width = '24px';
                        img.style.height = '24px';
                        img.style.verticalAlign = 'middle';
                        img.style.marginRight = '5px';
                        container.appendChild(img);
                    }
                    container.appendChild(document.createTextNode(item.content));
                    return container;
                },
                onAdd: function (item, callback) {
                    item.content = prompt('Enter text content for new item:', item.content);
                    item.image = 'img/flag.png';
                    if (item.content != null) {
                        callback(item);
                        saveEvents();
                    } else {
                        callback(null);
                    }
                },
                onMove: function (item, callback) {
                    callback(item);
                    saveEvents();
                },
                onUpdate: function (item, callback) {
                    item.content = prompt('Edit items text:', item.content);
                    if (item.content != null) {
                        callback(item);
                        saveEvents();
                    } else {
                        callback(null);
                    }
                },
                onRemove: function (item, callback) {
                    if (confirm('Remove item ' + item.content + '?')) {
                        callback(item);
                        saveEvents();
                    } else {
                        callback(null);
                    }
                }
            };

            timeline = new vis.Timeline(container, items, options);
        });
  </script>
</html>
